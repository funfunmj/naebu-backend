<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<title>NAEBU ADMIN</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<style>
body {
  margin: 0;
  padding: 20px;
  font-family: Arial, sans-serif;
  background: #111;
  color: #eee;
}
input, textarea, select, button {
  width: 100%;
  padding: 8px;
  margin: 5px 0;
  border-radius: 6px;
  border: none;
}
button { cursor: pointer; }
.card {
  background: #222;
  padding: 15px;
  margin-bottom: 15px;
  border-radius: 8px;
}
.hidden { display: none; }
</style>
</head>
<body>

<section id="loginSection">
  <h2>ê´€ë¦¬ì ë¡œê·¸ì¸</h2>
  <input id="passwordInput" type="password" placeholder="ë¹„ë°€ë²ˆí˜¸" />
  <button id="loginBtn">ë¡œê·¸ì¸</button>
</section>

<section id="adminSection" class="hidden">
  <h2>ë¬¸ì˜ ëª©ë¡</h2>
  <button onclick="logout()">ë¡œê·¸ì•„ì›ƒ</button>
  <div id="list"></div>
</section>

<script>
const loginSection = document.getElementById("loginSection");
const adminSection = document.getElementById("adminSection");
const listDiv = document.getElementById("list");
const passwordInput = document.getElementById("passwordInput");

/* =========================
   ğŸ”¥ ìë™ ë¡œê·¸ì¸ ì²´í¬
========================= */
window.addEventListener("DOMContentLoaded", async () => {
  const res = await fetch("/admin/check", {
    credentials: "include"
  });

  const data = await res.json();

  if (data.ok) {
    loginSection.classList.add("hidden");
    adminSection.classList.remove("hidden");
    loadEstimates();
  }
});

/* =========================
   ë¡œê·¸ì¸
========================= */
document.getElementById("loginBtn").addEventListener("click", async () => {
  const res = await fetch("/admin/login", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    credentials: "include",
    body: JSON.stringify({ password: passwordInput.value })
  });

  const data = await res.json();

  if (data.ok) {
    loginSection.classList.add("hidden");
    adminSection.classList.remove("hidden");
    loadEstimates();
  } else {
    alert("ë¹„ë°€ë²ˆí˜¸ ì˜¤ë¥˜");
  }
});

/* =========================
   ë¡œê·¸ì•„ì›ƒ
========================= */
async function logout(){
  await fetch("/admin/logout", {
    method: "POST",
    credentials: "include"
  });

  location.reload();
}

/* =========================
   ê²¬ì  ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
========================= */
async function loadEstimates() {
  const res = await fetch("/estimates", {
    credentials: "include"
  });

  const data = await res.json();

  if (!Array.isArray(data)) {
    console.error("ë°°ì—´ ì•„ë‹˜:", data);
    return;
  }

  listDiv.innerHTML = "";

  data.forEach(item => {
    const div = document.createElement("div");
    div.className = "card";

    div.innerHTML = `
      <b>ì´ë¦„:</b> ${item.name}<br>
      <b>ì „í™”:</b> ${item.phone}<br>
      <b>ì˜ˆì‚°:</b> ${item.budget || ""}<br>
      <b>ê³µê°„:</b> ${item.space || ""}<br>
      <b>ë‚´ìš©:</b> ${item.message || ""}<br><br>

      <b>ìƒíƒœ:</b>
      <select id="status-${item.id}" onchange="updateEstimate('${item.id}')">
        <option value="ëŒ€ê¸°" ${item.status=="ëŒ€ê¸°"?"selected":""}>ëŒ€ê¸°</option>
        <option value="ì§„í–‰ì¤‘" ${item.status=="ì§„í–‰ì¤‘"?"selected":""}>ì§„í–‰ì¤‘</option>
        <option value="ì™„ë£Œ" ${item.status=="ì™„ë£Œ"?"selected":""}>ì™„ë£Œ</option>
      </select>

      <br><br>

      <b>ë©”ëª¨:</b><br>
      <textarea id="memo-${item.id}">${item.memo || ""}</textarea>
      <br>
      <button onclick="updateEstimate('${item.id}')">ì €ì¥</button>
      <hr>
    `;

    listDiv.appendChild(div);
  });
}

/* =========================
   ìƒíƒœ + ë©”ëª¨ ì—…ë°ì´íŠ¸
========================= */
async function updateEstimate(id){
  const memo = document.getElementById("memo-"+id).value;
  const status = document.getElementById("status-"+id).value;

  await fetch("/estimates/" + id, {
    method: "PUT",
    headers: { "Content-Type": "application/json" },
    credentials: "include",
    body: JSON.stringify({ status, memo })
  });

  alert("ì €ì¥ ì™„ë£Œ");
}
</script>

</body>
</html>
